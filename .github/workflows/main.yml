name: RDP - Win11Pro UI (Fake)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        shell: powershell
        run: |
          # Bật Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name "fDenyTSConnections" -Value 0 -Force

          # Vô hiệu hóa NLA để dễ kết nối (nếu cần)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "SecurityLayer" -Value 0 -Force

          # Firewall rule cho RDP
          netsh advfirewall firewall delete rule name="RDP-Tailscale" || Write-Output "No existing rule"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

          Restart-Service -Name TermService -Force

      - name: Create Local User "ducthenggamingpro"
        shell: powershell
        run: |
          Add-Type -AssemblyName System.Security

          $charSet = @{
              Upper   = [char[]](65..90)
              Lower   = [char[]](97..122)
              Number  = [char[]](48..57)
              Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
          }

          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })

          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          if (Get-LocalUser -Name "ducthenggamingpro" -ErrorAction SilentlyContinue) {
            Write-Host "User exists - setting password and ensuring groups"
            Set-LocalUser -Name "ducthenggamingpro" -Password $securePass
          } else {
            New-LocalUser -Name "ducthenggamingpro" -Password $securePass -AccountNeverExpires -Description "RDP user"
          }

          Add-LocalGroupMember -Group "Administrators" -Member "ducthenggamingpro" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "ducthenggamingpro" -ErrorAction SilentlyContinue

          echo "RDP_USER=ducthenggamingpro" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Set Gojo Wallpaper (your uploaded image)
        shell: powershell
        run: |
          $url = "https://files.catbox.moe/3b6j4m.jpg"
          $path = "$env:PUBLIC\gojo_wallpaper.jpg"
          Invoke-WebRequest -Uri $url -OutFile $path -UseBasicParsing
          # Set wallpaper for all users (HKCU may require user context; try per-machine registry)
          reg add "HKCU\Control Panel\Desktop" /v Wallpaper /t REG_SZ /d "$path" /f
          # Try per-user update
          $sig = '[DllImport("user32.dll")] public static extern bool SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);'
          Add-Type -MemberDefinition $sig -Name "Native" -Namespace "WinAPI"
          [WinAPI.Native]::SystemParametersInfo(20, 0, $path, 3)

      - name: Install ExplorerPatcher (center taskbar + Win11-like start)
        shell: powershell
        run: |
          # ExplorerPatcher đem các chỉnh sửa taskbar/Start cho Explorer (OSS)
          $epUrl = "https://github.com/valinet/ExplorerPatcher/releases/latest/download/ExplorerPatcherSetup.exe"
          $epInstaller = "$env:TEMP\ExplorerPatcherSetup.exe"
          Invoke-WebRequest -Uri $epUrl -OutFile $epInstaller -UseBasicParsing

          # silent install (setup supports silent /S)
          Start-Process -FilePath $epInstaller -ArgumentList "/S" -Wait -NoNewWindow

          # Small sleep then restart explorer to let EP apply
          Start-Sleep -Seconds 6
          Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue
          Start-Process explorer

      - name: Apply Win11-like Theme & Center Taskbar via ExplorerPatcher JSON
        shell: powershell
        run: |
          # ExplorerPatcher stores settings per user. We'll write to EP registry/config where possible.
          # Note: On runners some settings may not persist; this tries to enable center taskbar.
          $epSettingsFile = "$env:LOCALAPPDATA\ep"  # EP may use registry; we'll attempt small registry tweaks
          # Use EP's command-line if available to set taskbar center (ep client exposes registry keys)
          reg add "HKCU\Software\ExplorerPatcher\Taskbar" /v centerTaskbar /t REG_DWORD /d 1 /f || Write-Output "Could not add EP center key"
          # Force Windows accent color + dark theme
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v AppsUseLightTheme /t REG_DWORD /d 0 /f
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v SystemUsesLightTheme /t REG_DWORD /d 0 /f

          # Set accent color (example: blue-ish). 0xFF1E90FF is ARGB, but registry needs decimal/or hex - set via Dword
          # We'll set a common accent color value
          reg add "HKCU\Software\Microsoft\Windows\DWM" /v AccentColor /t REG_DWORD /d 4286578815 /f

          # Restart explorer to apply theme settings
          Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          Start-Process explorer

      - name: Install Tailscale
        shell: powershell
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force -ErrorAction SilentlyContinue

      - name: Establish Tailscale Connection
        shell: powershell
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $exe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $exe)) {
            Write-Error "Tailscale executable not found
