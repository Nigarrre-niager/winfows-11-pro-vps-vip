name: üöÄ SERVER DucThengGaming

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '1_Gi·ªù_30_Ph√∫t_(90m)'
        type: choice
        options:
          - '30_Ph√∫t_(30m)'
          - '1_Gi·ªù_(60m)'
          - '1_Gi·ªù_30_Ph√∫t_(90m)'
          - '2_Gi·ªù_(120m)'
          - '2_Gi·ªù_30_Ph√∫t_(150m)'
          - '3_Gi·ªù_(180m)'
          - '3_Gi·ªù_30_Ph√∫t_(210m)'
          - '4_Gi·ªù_(240m)'
          - '4_Gi·ªù_30_Ph√∫t_(270m)'
          - '5_Gi·ªù_(300m)'
          - '5_Gi·ªù_30_Ph√∫t_(330m)'
          - '6_Gi·ªù_(360m)'
          - '30_Ng√†y_(43200m)'
          - '60_Ng√†y_(86400m)'
          - '90_Ng√†y_(129600m)'

jobs:
  DucThengGaming-RDP-Setup:
    runs-on: windows-latest
    steps:

      # BANNER CH√ÄO M·ª™NG
      - name: KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          $OutputEncoding = [System.Text.Encoding]::UTF8
          chcp 65001 > $null
          Write-Host "`n DucThengGaming RDP SERVER" -ForegroundColor Yellow
          Write-Host " Powered by DucThengGaming" -ForegroundColor Green
          Write-Host " Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      # C·∫§U H√åNH H·ªÜ TH·ªêNG
      - name: C·∫§U H√åNH H·ªÜ TH·ªêNG
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389
          Set-Service -Name TermService -StartupType Automatic
          Start-Service TermService
          Write-Host " C·∫•u h√¨nh RDP ho√†n t·∫•t" -ForegroundColor Green

      # T·∫†O USER PREMIUM
      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        shell: powershell
        run: |
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N DucThengGaming" -ForegroundColor Yellow

          function New-PremiumPassword {
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'
              $all = $upper + $lower + $numbers
              $pw = ''
              $pw += $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]
              for ($i = 1; $i -le 5; $i++) { $pw += $all[(Get-Random -Minimum 0 -Maximum $all.Length)] }
              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }

          if ($env:CUSTOM_RDP_PASS) { $matKhau = $env:CUSTOM_RDP_PASS } else { $matKhau = New-PremiumPassword }
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force

          try { Remove-LocalUser -Name "DucThengGaming" -ErrorAction SilentlyContinue } catch {}
          try {
              New-LocalUser -Name "DucThengGaming" -Password $securePass -AccountNeverExpires -Description "DucThengGaming Premium Account"
              Set-LocalUser -Name "DucThengGaming" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Administrators" -Member "DucThengGaming" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "DucThengGaming" -ErrorAction SilentlyContinue
              Enable-LocalUser -Name "DucThengGaming"
              Write-Host "‚îÇ ‚úÖ T·∫°o user DucThengGaming th√†nh c√¥ng" -ForegroundColor Green
          } catch { Write-Host "‚îÇ ‚ùå L·ªói t·∫°o user: $($_.Exception.Message)" -ForegroundColor Red; exit 1 }

          echo "RDP_USER=DucThengGaming" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt

      # TAILSCALE PREMIUM
      - name: üåê THI·∫æT L·∫¨P M·∫†NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        shell: powershell
        run: |
          Write-Host "üåê ƒêANG THI·∫æT L·∫¨P K·∫æT N·ªêI M·∫†NG" -ForegroundColor Yellow
          $msiPath = "$env:TEMP\tailscale-premium.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 10
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=DucThengGaming-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          
          # L·∫•y IP
          $ip = $null
          for($i=0; $i -lt 20; $i++) {
              try {
                  $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                  if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') { break }
              } catch {}
              Start-Sleep -Seconds 3
          }
          if ($ip -match '^\d+\.\d+\.\d+\.\d+$') { echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV } else { echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV }

      # KI·ªÇM TRA K·∫æT N·ªêI RDP
      - name: KI·ªÇM TRA K·∫æT N·ªêI RDP
        shell: pwsh
        run: |
          Write-Host " ƒê·ªãa ch·ªâ Tailscale: $env:TAILSCALE_IP"
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
          if (-not $testResult.TcpTestSucceeded) { Write-Error " Kh√¥ng th·ªÉ k·∫øt n·ªëi TCP ƒë·∫øn c·ªïng RDP (3389)."; exit 1 }

      # D·ªåN D·∫∏P FILE T·∫†M
      - name: üßπ D·ªåN D·∫∏P FILE T·∫†M
        if: always()
        shell: powershell
        run: |
          Remove-Item "$env:TEMP\rdp_password.txt" -Force -ErrorAction SilentlyContinue
          Write-Host "üßπ ƒê√£ d·ªçn d·∫πp file t·∫°m th√†nh c√¥ng!" -ForegroundColor Green

      # HI·ªÇN TH·ªä GIAO DI·ªÜN ƒê·∫∏P
      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        shell: pwsh
        run: |
          $matKhau = $env:RDP_PASS
          if (-not $matKhau) { $matKhau = "Kh√¥ng th·ªÉ ƒë·ªçc m·∫≠t kh·∫©u" }
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "30_Ph√∫t_(30m)" { $totalMinutes=30; $displayTime="30 ph√∫t" }
              "1_Gi·ªù_(60m)" { $totalMinutes=60; $displayTime="1 gi·ªù" }
              "1_Gi·ªù_30_Ph√∫t_(90m)" { $totalMinutes=90; $displayTime="1 gi·ªù 30 ph√∫t" }
              "2_Gi·ªù_(120m)" { $totalMinutes=120; $displayTime="2 gi·ªù" }
              "2_Gi·ªù_30_Ph√∫t_(150m)" { $totalMinutes=150; $displayTime="2 gi·ªù 30 ph√∫t" }
              "3_Gi·ªù_(180m)" { $totalMinutes=180; $displayTime="3 gi·ªù" }
              "3_Gi·ªù_30_Ph√∫t_(210m)" { $totalMinutes=210; $displayTime="3 gi·ªù 30 ph√∫t" }
              "4_Gi·ªù_(240m)" { $totalMinutes=240; $displayTime="4 gi·ªù" }
              "4_Gi·ªù_30_Ph√∫t_(270m)" { $totalMinutes=270; $displayTime="4 gi·ªù 30 ph√∫t" }
              "5_Gi·ªù_(300m)" { $totalMinutes=300; $displayTime="5 gi·ªù" }
              "5_Gi·ªù_30_Ph√∫t_(330m)" { $totalMinutes=330; $displayTime="5 gi·ªù 30 ph√∫t" }
              "6_Gi·ªù_(360m)" { $totalMinutes=360; $displayTime="6 gi·ªù" }
              "30_Ng√†y_(43200m)" { $totalMinutes=43200; $displayTime="30 ng√†y" }
              "60_Ng√†y_(86400m)" { $totalMinutes=86400; $displayTime="60 ng√†y" }
              "90_Ng√†y_(129600m)" { $totalMinutes=129600; $displayTime="90 ng√†y" }
          }
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          Write-Host "‚úÖ K·∫øt n·ªëi RDP th√†nh c√¥ng t·∫°i $env:TAILSCALE_IP v·ªõi user DucThengGaming"

      # DUY TR√å PHI√äN L√ÄM VI·ªÜC
      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        shell: pwsh
        run: |
          $totalMinutes = [int]$env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $startTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $endTime = $startTime.AddMinutes($totalMinutes)
          $monitorScript = {
              while ($true) {
                  $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  if ($termService.Status -ne 'Running') { Start-Service -Name TermService -ErrorAction SilentlyContinue }
                  Start-Sleep -Seconds 30
              }
          }
          Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"
          $infiniteRun = $totalMinutes -ge 43200
          do {
              $currentTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $timeLeft = $endTime - $currentTime
              $days = [math]::Max(0, [math]::Floor($timeLeft.TotalDays))
              $hours = [math]::Max(0, [math]::Floor($timeLeft.TotalHours % 24))
              $minutes = [math]::Max(0, [math]::Floor($timeLeft.TotalMinutes % 60))
              $seconds = [math]::Max(0, [math]::Floor($timeLeft.TotalSeconds % 60))
              if ($infiniteRun) { Write-Host ("üü¢ Ch·∫ø ƒë·ªô 24/7... {0}d {1}h {2}m {3}s" -f $days, $hours, $minutes, $seconds) -ForegroundColor Green }
              else { Write-Host ("‚è≥ Th·ªùi gian c√≤n l·∫°i: {0}d {1}h {2}m {3}s" -f $days, $hours, $minutes, $seconds) -ForegroundColor Cyan }
              Start-Sleep -Seconds 5
          } while ($infiniteRun -or $timeLeft.TotalSeconds -gt 0)
          Get-Job -Name "SystemMonitor" -ErrorAction SilentlyContinue | Stop-Job -PassThru | Remove-Job -Force

      # D·ªåN D·∫∏P CU·ªêI C√ôNG
      - name: D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        shell: powershell
        run: |
          Disable-LocalUser -Name "DucThengGaming" -ErrorAction SilentlyContinue
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all
          netsh advfirewall firewall delete rule name="RDP-Premium" 2>$null
          netsh advfirewall firewall delete rule name="RDP-Premium-Out" 2>$null
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
          Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
          Get-Job | Stop-Job -PassThru | Remove-Job -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ D·ªçn d·∫πp ho√†n t·∫•t!"
